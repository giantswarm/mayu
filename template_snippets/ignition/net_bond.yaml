{{define "net_bond"}}
networkd:
  units:
  - name: 10-bond0-slave.network
    contents: |
      [Match]
      Name=en*

      [Network]
      Bond=bond0

  - name: 20-bond0.network
    contents: |
      [Match]
      Name=bond0

      [Network]
      DHCP=none
      VLAN=bond0.{{.ClusterNetwork.VlanId}}

  - name: 15-bond0.netdev
    contents: |
      [NetDev]
      Name=bond0
      Kind=bond

      [Bond]
{{- if eq .ClusterNetwork.BondMode "lacp" }}
      Mode=802.3ad
      LACPTransmitRate=fast
      MIIMonitorSec=1s
      UpDelaySec=3s
      DownDelaySec=9s
{{else}}
      Mode=balance-rr
{{end}}
  - name: 35-bond0.{{.ClusterNetwork.VlanId}}.netdev
    contents: |
      [NetDev]
      Name=bond0.{{.ClusterNetwork.VlanId}}
      Kind=vlan

      [VLAN]
      Id={{.ClusterNetwork.VlanId}}

  - name: 40-vlan.network
    contents: |
      [Match]
      Name=bond0.{{.ClusterNetwork.VlanId}}

      [Network]
      Address={{.Host.InternalAddr}}/{{.ClusterNetwork.SubnetSize}}
      Gateway={{.ClusterNetwork.Router}}
      {{ range $server := .ClusterNetwork.DNS }}DNS={{ $server }}
      {{ end }}
      {{ range $server := .ClusterNetwork.NTP }}NTP={{ $server }}
      {{ end }}

{{end}}
